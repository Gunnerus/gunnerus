{% extends 'reserver/base.html' %}
{% load bootstrap3 %}
{% block content %}

{# Display a form #}
<section class="container">
	{% bootstrap_messages %}
	<div class="page-header">
		<h1>{% block header %}{% endblock %}</h1>
	</div>
	<div class="page-header">
		<h3>Ordering Information</h3>
	</div>
	<ul>
		<li><span class='text-warning glyphicon glyphicon-exclamation-sign' aria-hidden='true'></span> Almost all parts of this form are optional except for selecting cruise days and accepting the terms and conditions. However, filling it out as best you can is still strongly recommended, since this makes it easier for both you and the crew of the R/V Gunnerus to ensure that your cruise goes as intended.</li>
		<li>You will receive a confirmation email when your booking has been accepted.</li>
		<li>Cancellations later than three weeks before the cruise will be charged in full.</li>
		<li>If meals are to be arranged by the ship, the relevant items below must be filled in correctly at least one month before the start date of the cruise.</li>
	</ul>
	<form action="{{ request.path }}" method="post" class="form" enctype="multipart/form-data">
		{% csrf_token %}
		<div class="page-header">
			<h3>Cruise Details</h3>
		</div>
		<h4>Terms and Conditions</h4>
		<div class="terms-text-container well">
			<p>By agreeing to this user agreement you verify that you may act as cruise coordinator on behalf of your employer/department.</p>
			<p>You agree that the bookings you submit using this web application will be charged according to the price list on the booking info and ordering pages. This price list is not final; other fees may be due subject to the nature of your booking. Charges will be made to the registered billing information you enter in each booking.</p>
			<p>You agree that you will include all the necessary information in your booking, so that the crew is able to assess any risks and make necessary preparations in order to minimize them. You or your company/department will still need to cover the costs of the cruise, even if the lack of such information leads to delays or cancellation.</p>
			<p>You accept that the vessel may use part of the booked time for necessary activities such as refueling, replenishment, loading/unloading, safety exercises or similar activites.</p>
			<p>You agree to carry the cost of repair for any material damage done by you or the people accompanying you.</p>
			<p>You understand that the crew is in charge of the vessel’s operation and safety, and may stop operations as seems fit in order to keep it safe and to stay within working hours.</p>
			<p>The Gunnerus crew will make efforts to help you fulfill the aim of your cruise.</p>
			<p>If the vessel becomes unavailable due to defects, illness within the crew or other reasons not under NTNU’s control, you agree to not hold NTNU accountable for any losses this may put on your employer/department.</p>
		</div>
		{% bootstrap_form form %}
		{% if invoice_form %}
		<div class="cruiseInvoiceContainer">
			{{ invoice_form.management_form }}
			{{ invoice_form.non_form_errors }}
			<div class="invoiceForm panel panel-default">
				<div class="panel-heading">Invoice information</div>
				<div class="panel-body">
					{% bootstrap_form invoice_form %}
				</div>
			</div>
		</div>
		{% endif %}
		{% if cruiseday_form %}
		<div class="page-header">
			<h3>Select Cruise Days</h3>
		</div>
		<div class="panel panel-default calendar calendarContainer">
			<div class="panel-heading nav nav-default">
				<div class="pull-left">
					<h3>Cruise Calendar <span class="label label-default dateLabel">May 2017</span></h3>
				</div>
				<div class="btn-toolbar pull-right" role="group" aria-label="...">
					<div class="btn-group">
				  <button type="button" class="btn btn-default calPreviousButton"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span></button>
				  <button type="button" class="btn btn-default calNextButton"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span></button>
				  <button type="button" class="btn btn-default calTodayButton">Today</button>
					</div>
				  <div class="btn-group" role="group">
					<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
					  View
					  <span class="caret"></span>
					</button>
					<ul class="dropdown-menu">
						<li><a href="#" class="calYearButton">Year</a></li>
						<li><a href="#" class="calMonthButton">Month</a></li>
						<!--<li><a href="#" class="calWeekButton">Week</a></li>
						<li><a href="#" class="calDayButton">Day</a></li>-->
					</ul>
				  </div>
				</div>
			</div>
		  <div class="panel-body">
			<div class="insert-calendar"></div>
		  </div>
		  <div class="panel-footer">
			<div class="btn-toolbar" role="group" aria-label="...">
			  <div class="btn-group pull-left">
					 <button type="button" class="btn btn-default calPreviousButton"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span></button>
			  </div>
			  <div class="btn-group pull-right">
				  <button type="button" class="btn btn-default calNextButton"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span></button>
			  </div>
			 </div>
		  </div>
		</div>
		<div class="cruiseDaysContainer panel-group" id="accordion" role="tablist">
			{{ cruiseday_form.management_form }}
			{{ cruiseday_form.non_form_errors }}
			{% for form in cruiseday_form %}
				<div class="cruiseDayForm">
					<div class="panel-heading"><a role="button" data-toggle="collapse" data-parent="#accordion" href="#panel{{ form.initial.id }}" aria-expanded="true" aria-controls="panel{{ form.initial.id }}"></a>Cruise day - <span class="date-container"></span></div>
					<div id="panel{{ form.initial.id }}" class="panel-collapse collapse" role="tabpanel">
						<div class="panel-body">
							{% bootstrap_form form %}
						</div>
					</div>
				</div>
			{% endfor %}
		</div>
		{% endif %}
		{% if participant_form %}
		<div class="page-header">
			<h3>Add Participants</h3>
		</div>
		<p class="help-block">Here you may specify personal details for each cruise participant individually. This replaces the previous MOB sheet.</p>
		<div class="cruiseParticipantsContainer">
			{{ participant_form.management_form }}
			{{ participant_form.non_form_errors }}
			{% for form in participant_form %}
				<div class="participantForm">
					<div class="panel-heading">Participant</div>
					<div class="panel-body">
						{% bootstrap_form form %}
					</div>
				</div>
			{% endfor %}
		</div>
		{% endif %}
		{% if document_form %}
		<div class="page-header">
			<h3>Add Documents</h3>
		</div>
		<p class="help-block">You may use this form for including any relevant documents and files for your cruise, such as chemical datasheets.</p>
		<div class="cruiseDocumentsContainer">
			{{ document_form.management_form }}
			{{ document_form.non_form_errors }}
			{% for form in document_form %}
				<div class="documentForm">
					<div class="panel-heading">Document</div>
					<div class="panel-body">
						{% bootstrap_form form %}
					</div>
				</div>
			{% endfor %}
		</div>
		{% endif %}
		{% if equipment_form %}
		<div class="page-header">
			<h3>Add Equipment</h3>
		</div>
		<p class="help-block">Does your cruise require or bring any special equipment, such as heavy loads or anything else that requires special handling or consideration on board? If so, please specify these here.</p>
		<div class="cruiseEquipmentContainer">
			{{ equipment_form.management_form }}
			{{ equipment_form.non_form_errors }}
			{% for form in equipment_form %}
				<div class="equipmentForm">
					<div class="panel-heading">Equipment</div>
					<div class="panel-body">
						{% bootstrap_form form %}
					</div>
				</div>
			{% endfor %}
		</div>
		{% endif %}
		<div class="submitButtonsContainer">
			<div class="submitButtonsContainer-scroller">
				<div class="container">{% block submitbuttons %}{% endblock %}</div>
			</div>
		</div>
	</form>
</section>
{% endblock %}
{% block scripts %}
<script type="text/javascript">
	if (window.location.href.indexOf("cruises/add/") == -1) {
		$(".cruiseDayForm").each(function() {
			$(this).find(".date-container").text(new Date($(this).find("[placeholder=Date]").val()).format("D jS \\o\\f F Y"));
			selected_dates.push(new Date($(this).find("[placeholder=Date]").val()));
			$(this).find("[placeholder=Date]").closest(".form-group").hide();
		});
	}
		
	if (window.location.href.indexOf("/add/") != -1 || window.location.href.indexOf("/edit/") != -1) {
		var calendar = new Calendar($(".calendarContainer"));
	} else {
		$(".calendarContainer").remove();
	}
	
	

	var wrap = function(row){ 
		console.log(row);
		$(row).addClass("panel panel-default");
		var id_regex = /cruise\-(\d+)\-date/;
		if (id_regex.test($(row).find("[placeholder=Date]").attr('name'))) {
			if ($(row).find(".panel-heading a").attr("href") == "#panel") {
				var id = id_regex.exec($(row).find("[placeholder=Date]").attr('name'))[1];
				$(row).find(".panel-heading a").attr("href", "#panel"+id);
				$(row).find(".panel-collapse").attr("id", "panel"+id);
			}
		}
		$(row).find(".delete-row").addClass("btn btn-danger"); 
		$(".foodSelector").each(function() {
			checkAndHideFoodFields(this);
		});
	};
	
	$(".foodSelector, .add-cruise-day").click(function(e) {
		checkAndHideFoodFields(e.target);
	});
	
	function checkAndHideFoodFields(food_selector) {
		food_selector = $(food_selector);
		form = food_selector.closest(".cruiseDayForm");
		if (food_selector.prop('checked')) {
			food_selector.closest(".cruiseDayForm").find(".food").closest(".form-group").show();
		} else {
			food_selector.closest(".cruiseDayForm").find(".food").closest(".form-group").hide();
		}
	}
	
	function checkAndHideNoStudentField() {
		if ($("#id_student_participation_ok").is(":checked")) {
			$("#id_no_student_reason").closest(".form-group").hide();
		} else {
			$("#id_no_student_reason").closest(".form-group").show();
		}
	}
	
	/*$(".noStudentSelector").click(function(e) {
		checkAndHideStudentField(e.target);
	});
	
	function checkAndHideStudentField(nostudentreason_selector) {
		nostudentreason_selector = $(food_selector);
		form = nostudentreason_selector.closest(".cruiseDayForm");
		if (nostudentreason_selector.prop('checked')) {
			nostudentreason_selector.closest(".cruiseDayForm").find(".food").closest(".form-group").show();
		} else {
			nostudentreason_selector.closest(".cruiseDayForm").find(".food").closest(".form-group").hide();
		}
	}*/
	
	
	function checkAndHideFoodFields(food_selector) {
		food_selector = $(food_selector);
		form = food_selector.closest(".cruiseDayForm");
		if (food_selector.prop('checked')) {
			food_selector.closest(".cruiseDayForm").find(".food").closest(".form-group").show();
		} else {
			food_selector.closest(".cruiseDayForm").find(".food").closest(".form-group").hide();
		}
	}
	
	$(function() {
		$('.cruiseDayForm').formset({
			prefix: '{{ cruiseday_form.prefix }}',
			formCssClass: 'cruisedays',
			addCssClass: 'btn btn-success add-cruise-day',
			addText: 'Add cruise day', 
			deleteText: 'Remove cruise day',
			added: wrap
		});
		
		$('.participantForm').formset({
			prefix: '{{ participant_form.prefix }}',
			formCssClass: 'participants',
			addCssClass: 'btn btn-success add-participant', 
			addText: 'Add participant',
			deleteText: 'Remove participant',
			added: wrap
		});

		$('.documentForm').formset({
			prefix: '{{ document_form.prefix }}',
			formCssClass: 'documents',
			addCssClass: 'btn btn-success add-document', 
			addText: 'Add document',
			deleteText: 'Remove document',
			added: wrap
		});
		
		$('.equipmentForm').formset({
			prefix: '{{ equipment_form.prefix }}',
			formCssClass: 'equipment',
			addCssClass: 'btn btn-success add-equipment', 
			addText: 'Add equipment',
			deleteText: 'Remove equipment',
			added: wrap
		});
		
		wrap('.cruiseDayForm'); 
		wrap('.participantForm');
		wrap('.documentForm');
		wrap('.equipmentForm');
		
		$('.cruiseDayForm').each(function(){
			var cruiseForm = this;
			$(cruiseForm).find(".food").each(function(e){
				if ((Number($(this).val()) > 0)) {
					$(cruiseForm).find(".foodSelector").prop("checked", true);
				}
			});
		});
		
		checkAndHideNoStudentField();
		
		$("#id_student_participation_ok").on("change", function(e) {	
			checkAndHideNoStudentField();
		});

		
		$(".foodSelector").each(function() {
			checkAndHideFoodFields(this);
		});
		
		$(".documentForm a").each(function() {
			$(this).attr("target", "_BLANK");
		});
		
		$(".submitButtonsContainer").outerHeight($(".submitButtonsContainer-scroller").outerHeight());

		$(window).scroll(function(){
			if($(window).scrollTop()+$(window).height() > ($(".submitButtonsContainer").offset().top + $(".submitButtonsContainer").outerHeight())){
			   $(".submitButtonsContainer-scroller").removeClass("scrolling");
			} else {
			   $(".submitButtonsContainer-scroller").addClass("scrolling");
			}
		});
		
		$(".cruiseDaysContainer .cruiseDayForm:visible .delete-row").last().click();
		
		if (start_date != "" && end_date != "")  {
			console.log("both dates are set");
			update_range($(".calendarContainer").find(".cal-cell"), start_date);
			if (start_date != end_date) {
				update_range($(".calendarContainer").find(".cal-cell"), end_date);
			}
		}
		
		$('.panel-collapse').on('show.bs.collapse', function () {
			$(this).siblings('.panel-heading').addClass('active');
		});

		$('.panel-collapse').on('hide.bs.collapse', function () {
			$(this).siblings('.panel-heading').removeClass('active');
		});
	});
</script>
{% block extra-scripts %}{% endblock %}
{% endblock %}
{# Read the documentation for more information #}