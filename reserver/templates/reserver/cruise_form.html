{% extends 'reserver/base.html' %}
{% load bootstrap3 %}
{% block content %}

{# Display a form #}
<script>
{% if is_NTNU %}
var is_NTNU = true;
{% else %}
var is_NTNU = false;
{% endif %}
</script>
<section class="form-wrapper container">
	<div class="form-container">
		{% bootstrap_messages %}
		<div class="page-header">
			<h1>{% block header %}{% endblock %}</h1>
		</div>
		<div id="ordering-info" class="jump-anchor"></div>
		<div class="page-header">
			<h3>Ordering Information</h3>
		</div>
		<ul>
			<li><span class='text-warning glyphicon glyphicon-exclamation-sign' aria-hidden='true'></span> Almost all parts of this form are optional except for selecting cruise days and accepting the terms and conditions. However, filling it out as best you can is still strongly recommended, since this makes it easier for both you and the crew of the R/V Gunnerus to ensure that your cruise goes as intended.</li>
			<li>You will receive a confirmation email when your booking has been accepted.</li>
			<li>Cancellations later than three weeks before the cruise will be charged in full.</li>
			<li>If meals are to be arranged by the ship, the relevant items below must be filled in correctly at least one month before the start date of the cruise.</li>
		</ul>
		<form action="{{ request.path }}" method="post" class="form" enctype="multipart/form-data">
			{% csrf_token %}
			<div id="cruise-details" class="jump-anchor"></div>
			<div class="page-header">
				<h3>Cruise Details</h3>
			</div>
			<h4>Terms and Conditions</h4>
			<div class="terms-text-container well">
				<p>By agreeing to this user agreement you verify that you may act as cruise coordinator on behalf of your employer/department.</p>
				<p>You agree that the bookings you submit using this web application will be charged according to the price list on the booking info and ordering pages. This price list is not final; other fees may be due subject to the nature of your booking. Charges will be made to the registered billing information you enter in each booking.</p>
				<p>You agree that you will include all the necessary information in your booking, so that the crew is able to assess any risks and make necessary preparations in order to minimize them. You or your company/department will still need to cover the costs of the cruise, even if the lack of such information leads to delays or cancellation.</p>
				<p>You accept that the vessel may use part of the booked time for necessary activities such as refueling, replenishment, loading/unloading, safety exercises or similar activites.</p>
				<p>You agree to carry the cost of repair for any material damage done by you or the people accompanying you.</p>
				<p>You understand that the crew is in charge of the vessel’s operation and safety, and may stop operations as seems fit in order to keep it safe and to stay within working hours.</p>
				<p>The Gunnerus crew will make efforts to help you fulfill the aim of your cruise.</p>
				<p>If the vessel becomes unavailable due to defects, illness within the crew or other reasons not under NTNU’s control, you agree to not hold NTNU accountable for any losses this may put on your employer/department.</p>
			</div>
			{% bootstrap_form form %}
			{% if invoice_form %}
			<div id="invoice-form" class="jump-anchor"></div>
			<h4>Invoice and pricing</h4>
			<div id="internal-pricing-options">
				<p class="help-block">Please select your pricing category. Education cruises have project numbers starting in 7 or 8, while BOA project numbers start with a letter.</p>
				<div class="btn-group" data-toggle="buttons" id="pricing-selector">
					  <label class="btn btn-primary" id="education">
						<input type="radio" name="options"> Education
					  </label>
					  <label class="btn btn-primary" id="research">
						<input type="radio" name="options"> Research
					  </label>
					  <label class="btn btn-primary" id="boa">
						<input type="radio" name="options"> BOA
					  </label>
				</div>
				<p></p>
			</div>
			<div class="cruiseInvoiceContainer">
				{{ invoice_form.management_form }}
				{{ invoice_form.non_form_errors }}
				{% for form in invoice_form %}
					<div class="invoiceForm panel panel-default">
						<div class="panel-heading">Invoice information</div>
						<div class="panel-body collapse panel-collapse">
							{% bootstrap_form form %}
						</div>
					</div>
				{% endfor %}
			</div>
			{% endif %}
			{% if cruiseday_form %}
			<div id="cruise-days" class="jump-anchor"></div>
			<div class="page-header">
				<h3>Select Cruise Days</h3>
			</div>
			<div class="panel panel-default calendar calendarContainer">
				<div class="panel-heading nav nav-default">
					<div class="pull-left">
						<h3>Cruise Calendar <span class="label label-default dateLabel">May 2017</span></h3>
					</div>
					<div class="btn-toolbar pull-right" role="group" aria-label="...">
						<div class="btn-group">
					  <button type="button" class="btn btn-default calPreviousButton"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span></button>
					  <button type="button" class="btn btn-default calNextButton"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span></button>
					  <button type="button" class="btn btn-default calTodayButton">Today</button>
						</div>
					  <div class="btn-group" role="group">
						<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
						  View
						  <span class="caret"></span>
						</button>
						<ul class="dropdown-menu">
							<li><a href="#" class="calYearButton">Year</a></li>
							<li><a href="#" class="calMonthButton">Month</a></li>
							<!--<li><a href="#" class="calWeekButton">Week</a></li>
							<li><a href="#" class="calDayButton">Day</a></li>-->
						</ul>
					  </div>
					</div>
				</div>
			  <div class="panel-body">
				<div class="insert-calendar"></div>
			  </div>
			  <div class="panel-footer">
				<div class="btn-toolbar" role="group" aria-label="...">
				  <div class="btn-group pull-left">
						 <button type="button" class="btn btn-default calPreviousButton"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span></button>
				  </div>
				  <div class="btn-group pull-right">
					  <button type="button" class="btn btn-default calNextButton"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span></button>
				  </div>
				 </div>
			  </div>
			</div>
			<div class="cruiseDaysContainer panel-group" id="accordion" role="tablist">
				{{ cruiseday_form.management_form }}
				{{ cruiseday_form.non_form_errors }}
				{% for form in cruiseday_form %}
					<div class="cruiseDayForm">
						<div class="panel-heading"><a role="button" data-toggle="collapse" data-parent="#accordion" href="#panel{{ form.initial.id }}" aria-expanded="true" aria-controls="panel{{ form.initial.id }}"></a>Cruise day - <span class="date-container"></span></div>
						<div id="panel{{ form.initial.id }}" class="panel-collapse collapse" role="tabpanel">
							<div class="panel-body">
								{% bootstrap_form form %}
							</div>
						</div>
					</div>
				{% endfor %}
			</div>
			{% endif %}
			{% if participant_form %}
			<div id="participants" class="jump-anchor"></div>
			<div class="page-header">
				<h3>Add Participants</h3>
			</div>
			<p class="help-block">Here you may specify personal details for each cruise participant individually. This replaces the previous MOB sheet.</p>
			<div class="cruiseParticipantsContainer">
				{{ participant_form.management_form }}
				{{ participant_form.non_form_errors }}
				{% for form in participant_form %}
					<div class="participantForm">
						<div class="panel-heading">Participant</div>
						<div class="panel-body">
							{% bootstrap_form form %}
						</div>
					</div>
				{% endfor %}
			</div>
			{% endif %}
			{% if document_form %}
			<div id="documents" class="jump-anchor"></div>
			<div class="page-header">
				<h3>Add Documents</h3>
			</div>
			<p class="help-block">You may use this form for including any relevant documents and files for your cruise, such as chemical datasheets.</p>
			<div class="cruiseDocumentsContainer">
				{{ document_form.management_form }}
				{{ document_form.non_form_errors }}
				{% for form in document_form %}
					<div class="documentForm">
						<div class="panel-heading">Document</div>
						<div class="panel-body">
							{% bootstrap_form form %}
						</div>
					</div>
				{% endfor %}
			</div>
			{% endif %}
			{% if equipment_form %}
			<div id="equipment" class="jump-anchor"></div>
			<div class="page-header">
				<h3>Add Equipment</h3>
			</div>
			<p class="help-block">Does your cruise require or bring any special equipment, such as heavy loads or anything else that requires special handling or consideration on board? If so, please specify these here.</p>
			<div class="cruiseEquipmentContainer">
				{{ equipment_form.management_form }}
				{{ equipment_form.non_form_errors }}
				{% for form in equipment_form %}
					<div class="equipmentForm">
						<div class="panel-heading">Equipment</div>
						<div class="panel-body">
							{% bootstrap_form form %}
						</div>
					</div>
				{% endfor %}
			</div>
			{% endif %}
			<div id="order-summary" class="jump-anchor"></div>
			<div class="page-header">
				<h3>Order Summary</h3>
			</div>
			<div id="order-summary-container">
			<p>Please select some cruise days.</p>
			</div>
			<div class="submitButtonsContainer">
				<div class="submitButtonsContainer-scroller">
					<div class="container">{% block submitbuttons %}{% endblock %}</div>
				</div>
			</div>
		</form>
	</div>
	<div class="sidebar-container">
		<div class="form-nav panel panel-primary">
			<div class=" panel-heading">
				<h4 class="panel-header"><i class="fa fa-info-circle" aria-hidden="true"></i> Current Section</h4>
			</div>
			<div class="panel-body">
				<nav class="scrollSpyTarget">
					<ul class="nav nav-pills nav-stacked">
						<li><a href="#ordering-info">Ordering Information</a></li>
						<li><a href="#cruise-details">Cruise Details</a></li>
						<li><a href="#invoice-form">Invoice Information</a></li>
						<li><a href="#cruise-days">Cruise Days</a></li>
						<li><a href="#participants">Participants</a></li>
						<li><a href="#documents">Documents</a></li>
						<li><a href="#equipment">Equipment</a></li>
						<li><a href="#order-summary">Order Summary</a></li>
					</ul>
				</nav>
			</div>
		</div>
	</div>
</section>
{% endblock %}
{% block scripts %}
<script type="text/javascript">
	function update_sum() {
		$.ajax({
			url: '/cruises/cost/',
			type: 'POST',
			contentType: 'application/json; charset=utf-8',
			data: JSON.stringify(get_cruise_data()),
			dataType: 'json',
			success: function(result) {
				json_result = JSON.parse(result);
				$(".cruise-cost").html(json_result.sum);
				$("#order-summary-container").html(render_receipt(json_result));
			}
		});
	}
	
	function get_cruise_pricing_category() {
		if (is_NTNU) {
			var project_number = document.querySelector("input[name*='project_number']").value;
			if (project_number.length > 1) {
				if (/^ *[a-zA-Z]/.test(project_number)) {
					$("#education").click();
					return "education";
				} else if (/^ *[78]/.test(project_number)) {
					$("#boa").click();
					return "boa";
				} else {
					$("#research").click();
					return "research";
				}
			} else {
				return "research";
			}
		} else {
			return "external";
		}
	}
	
	function get_cruise_data() {
		var dates = [];
		
		var short_days = 0;
		var long_days = 0;
		
		var breakfasts = 0;
		var lunches = 0;
		var dinners = 0;
		
		var type = "";
		
		$(".cruiseDayForm").filter(":visible").each(function(i){
			if ($(this).find("input[name*='is_long_day']").is(":checked")) {
				long_days++;
			} else {
				short_days++;
			}
			
			dates.push($(this).find("[placeholder=Date]").val());
			
			breakfast_count = parseInt($(this).find("input[name*='breakfast']").val());
			breakfasts += isNaN(breakfast_count) ? 0 : breakfast_count;
			
			lunch_count = parseInt($(this).find("input[name*='lunch']").val());
			lunches += isNaN(lunch_count) ? 0 : lunch_count;
			
			dinner_count = parseInt($(this).find("input[name*='dinner']").val());
			dinners += isNaN(dinner_count) ? 0 : dinner_count;
		});
		
		type = get_cruise_pricing_category();
		
		var cruise_data = {
			breakfasts: breakfasts,
			lunches: lunches,
			dinners: dinners,
			short_days: short_days,
			long_days: long_days,
			dates: dates,
			type: type
		};
		
		console.log(cruise_data);
		return cruise_data;
	}
	
	function render_receipt(json_result) {
		receipt_html = '<div class="alert alert-info"><i class="fa fa-info-circle" aria-hidden="true"></i> This cruise is in the ' + json_result.type + ' billing category.</div><table class="table order-summary"><thead><tr><th>Item</th><th>Amount</th><th>Cost</th></tr></thead><tbody>';
		for (var i = 0; i < json_result.items.length; i++) {
			receipt_html += '<tr><td>' + json_result.items[i].name + '</td><td>' + json_result.items[i].count + '</td><td>' + json_result.items[i].list_cost + ' NOK</td></tr>';
		}
		receipt_html += '<tr class="active"><td colspan="2" class="sum-label">Sum</td><td>' + json_result.sum + ' NOK</td></tr>';
		receipt_html += '</tbody></table>';
		return receipt_html;
	}
	
	$(".submitButtonsContainer .container .form-group").prepend('<a id="cruise_receipt_button" href="javascript:void(0)" class="cost-button btn btn-default"><i class="fa fa-wpforms" aria-hidden="true"></i> <span class="cruise-cost">0</span> NOK</a>');
	$("#cruise_receipt_button").on("click", function(){
		$.ajax({
			url: '/cruises/cost/',
			type: 'POST',
			contentType: 'application/json; charset=utf-8',
			data: JSON.stringify(get_cruise_data()),
			dataType: 'json',
			success: function(result) {
				json_result = JSON.parse(result);
				console.log(json_result);
				receipt_html = render_receipt(json_result);
				showDialog("Order summary", receipt_html);
			}
		});
	});
	if (window.location.href.indexOf("cruises/add/") == -1) {
		$(".cruiseDayForm").each(function() {
			$(this).find(".date-container").text(new Date($(this).find("[placeholder=Date]").val()).format("D jS \\o\\f F Y"));
			selected_dates.push(new Date($(this).find("[placeholder=Date]").val()));
			$(this).find("[placeholder=Date]").closest(".form-group").hide();
		});
	}
		
	if (window.location.href.indexOf("/add/") != -1 || window.location.href.indexOf("/edit/") != -1) {
		var calendar = new Calendar($(".calendarContainer"));
	} else {
		$(".calendarContainer").remove();
	}

	var wrap = function(row){ 
		console.log(row);
		$(row).addClass("panel panel-default");
		var id_regex = /cruise\-(\d+)\-date/;
		if (id_regex.test($(row).find("[placeholder=Date]").attr('name'))) {
			if ($(row).find(".panel-heading a").attr("href") == "#panel") {
				var id = id_regex.exec($(row).find("[placeholder=Date]").attr('name'))[1];
				$(row).find(".panel-heading a").attr("href", "#panel"+id);
				$(row).find(".panel-collapse").attr("id", "panel"+id);
			}
		}
		$(row).find(".delete-row").addClass("btn btn-danger"); 
		$(".foodSelector").each(function() {
			checkAndHideFoodFields(this);
		});
	};
	
	$(".foodSelector, .add-cruise-day").click(function(e) {
		checkAndHideFoodFields(e.target);
	});
	
	function checkAndHideFoodFields(food_selector) {
		food_selector = $(food_selector);
		form = food_selector.closest(".cruiseDayForm");
		if (food_selector.prop('checked')) {
			food_selector.closest(".cruiseDayForm").find(".food").closest(".form-group").show();
		} else {
			food_selector.closest(".cruiseDayForm").find(".food").closest(".form-group").hide();
		}
	}
	
	function checkAndHideNoStudentField() {
		if ($("#id_student_participation_ok").is(":checked")) {
			$("#id_no_student_reason").closest(".form-group").hide();
		} else {
			$("#id_no_student_reason").closest(".form-group").show();
		}
	}
	
	/*$(".noStudentSelector").click(function(e) {
		checkAndHideStudentField(e.target);
	});
	
	function checkAndHideStudentField(nostudentreason_selector) {
		nostudentreason_selector = $(food_selector);
		form = nostudentreason_selector.closest(".cruiseDayForm");
		if (nostudentreason_selector.prop('checked')) {
			nostudentreason_selector.closest(".cruiseDayForm").find(".food").closest(".form-group").show();
		} else {
			nostudentreason_selector.closest(".cruiseDayForm").find(".food").closest(".form-group").hide();
		}
	}*/
	
	$(document).click(function(event) { 
		if(!$(event.target).closest('.form-nav').length) {
			if($('.form-nav:not(.closed)') && document.querySelector(".wrapped")) {
				$(".form-nav").addClass("closed");
			}
		}
	});
	
	function resizeHandler() {
		$(".form-nav").css("width", $(".sidebar-container").width()+"px");
		if ($(".form-wrapper").width() < 600) {
			$(".form-wrapper").addClass("wrapped");
			$(".form-wrapper .form-nav").addClass("closed");
		} else {
			$(".form-wrapper").removeClass("wrapped");
			$(".form-wrapper .form-nav").removeClass("closed");
		}
	}
	
	$(window).resize(function() {
		clearTimeout(window.resizedFinished);
		window.resizedFinished = setTimeout(function(){
			resizeHandler();
			/* run again after document reflow */
			setTimeout(resizeHandler, 150);
		}, 250);
	});
		
	function checkAndHideFoodFields(food_selector) {
		food_selector = $(food_selector);
		form = food_selector.closest(".cruiseDayForm");
		if (food_selector.prop('checked')) {
			food_selector.closest(".cruiseDayForm").find(".food").closest(".form-group").show();
		} else {
			food_selector.closest(".cruiseDayForm").find(".food").closest(".form-group").hide();
		}
	}
	
	$(function() {
		if (is_NTNU) {
			$("#internal-pricing-options").show();
			$("input[name*='business_reg_num']").closest(".form-group").hide();
			$("input[name*='billing_address'][name*='invoiceinformation']").closest(".form-group").hide();
			$(".invoiceForm .panel-body").collapse("hide");
			$("#boa").on("click", function(){
				$("input[name*='accounting_place']").closest(".form-group").show();
				$("input[name*='project_number']").closest(".form-group").show();
				$("input[name*='project_leader']").closest(".form-group").show();	
				$("input[name*='course_lecturer']").closest(".form-group").hide();
				$("input[name*='course_code']").closest(".form-group").hide();
				$("input[name*='reference']").closest(".form-group").hide();
				$("input[name*='contact_name']").closest(".form-group").hide();
				$("input[name*='contact_email']").closest(".form-group").hide();
				$(".invoiceForm .panel-body").collapse("show");
			});
			$("#education").on("click", function(){
				$("input[name*='accounting_place']").closest(".form-group").show();
				$("input[name*='project_number']").closest(".form-group").show();
				$("input[name*='project_leader']").closest(".form-group").hide();	
				$("input[name*='course_lecturer']").closest(".form-group").show();
				$("input[name*='course_code']").closest(".form-group").show();
				$("input[name*='reference']").closest(".form-group").hide();
				$("input[name*='contact_name']").closest(".form-group").hide();
				$("input[name*='contact_email']").closest(".form-group").hide();
				$(".invoiceForm .panel-body").collapse("show");
			});
			$("#research").on("click", function(){
				$("input[name*='accounting_place']").closest(".form-group").show();
				$("input[name*='project_number']").closest(".form-group").show();
				$("input[name*='project_leader']").closest(".form-group").show();	
				$("input[name*='course_lecturer']").closest(".form-group").hide();
				$("input[name*='course_code']").closest(".form-group").hide();
				$("input[name*='reference']").closest(".form-group").hide();
				$("input[name*='contact_name']").closest(".form-group").hide();
				$("input[name*='contact_email']").closest(".form-group").hide();
				$(".invoiceForm .panel-body").collapse("show");
			});
		} else {
			$("#internal-pricing-options").hide();
			$("input[name*='project_number']").closest(".form-group").hide();
			$("input[name*='course_lecturer']").closest(".form-group").hide();
			$("input[name*='course_code']").closest(".form-group").hide();
			$("input[name*='project_leader']").closest(".form-group").hide();
		}
		
		$('.cruiseDayForm').formset({
			prefix: '{{ cruiseday_form.prefix }}',
			formCssClass: 'cruisedays',
			addCssClass: 'btn btn-success add-cruise-day',
			addText: 'Add cruise day', 
			deleteText: 'Remove cruise day',
			added: wrap
		});
		
		$('.participantForm').formset({
			prefix: '{{ participant_form.prefix }}',
			formCssClass: 'participants',
			addCssClass: 'btn btn-success add-participant', 
			addText: 'Add participant',
			deleteText: 'Remove participant',
			added: wrap
		});

		$('.documentForm').formset({
			prefix: '{{ document_form.prefix }}',
			formCssClass: 'documents',
			addCssClass: 'btn btn-success add-document', 
			addText: 'Add document',
			deleteText: 'Remove document',
			added: wrap
		});
		
		$('.equipmentForm').formset({
			prefix: '{{ equipment_form.prefix }}',
			formCssClass: 'equipment',
			addCssClass: 'btn btn-success add-equipment', 
			addText: 'Add equipment',
			deleteText: 'Remove equipment',
			added: wrap
		});
		
		wrap('.cruiseDayForm'); 
		wrap('.participantForm');
		wrap('.documentForm');
		wrap('.equipmentForm');
		
		$('.cruiseDayForm').each(function(){
			var cruiseForm = this;
			$(cruiseForm).find(".food").each(function(e){
				if ((Number($(this).val()) > 0)) {
					$(cruiseForm).find(".foodSelector").prop("checked", true);
				}
			});
		});
		
		checkAndHideNoStudentField();
		
		$("#id_student_participation_ok").on("change", function(e) {	
			checkAndHideNoStudentField();
		});

		
		$(".foodSelector").each(function() {
			checkAndHideFoodFields(this);
		});
		
		$(".documentForm a").each(function() {
			$(this).attr("target", "_BLANK");
		});
		
		$(".submitButtonsContainer").outerHeight($(".submitButtonsContainer-scroller").outerHeight());

		$(window).scroll(function(){
			if($(window).scrollTop()+$(window).height() > ($(".submitButtonsContainer").offset().top + $(".submitButtonsContainer").outerHeight())){
			   $(".submitButtonsContainer-scroller").removeClass("scrolling");
			} else {
			   $(".submitButtonsContainer-scroller").addClass("scrolling");
			}
		});
		
		$(".cruiseDaysContainer .cruiseDayForm:visible .delete-row").last().click();
		
		if (start_date != "" && end_date != "")  {
			console.log("both dates are set");
			update_range($(".calendarContainer").find(".cal-cell"), start_date);
			if (start_date != end_date) {
				update_range($(".calendarContainer").find(".cal-cell"), end_date);
			}
		}
		
		$('.panel-collapse').on('show.bs.collapse', function () {
			$(this).siblings('.panel-heading').addClass('active');
		});

		$('.panel-collapse').on('hide.bs.collapse', function () {
			$(this).siblings('.panel-heading').removeClass('active');
		});
		
		$(".invoiceForm").not(':first').remove();
		
		update_sum();
		
		if (document.querySelector(".form-nav")) {
			$(".form-nav").affix({offset: {top: $(".form-wrapper .form-container").position().top-$(".navbar").height(), bottom: $(document).outerHeight()-($(".form-wrapper").position().top+$(".form-wrapper").outerHeight())}});
		}
		
		$(".toggle-cost-container").click(function() {
			if (document.querySelector(".wrapped")) {
				$(".form-nav").toggleClass("closed");
			}
		});
		
		resizeHandler();
		
		setTimeout(resizeHandler, 150);
	});
	
	$(".cal-month-day, .order-now, input[name*='breakfast'], input[name*='lunch'], input[name*='dinner'], input[name*='is_long_day']").on("click", function(){
		update_sum();
	});
	
	$("input[name*='breakfast'], input[name*='project_number'], input[name*='lunch'], input[name*='dinner'], input[name*='is_long_day']").on("change", function(){
		update_sum();
	});
</script>
{% block extra-scripts %}{% endblock %}
{% endblock %}
{# Read the documentation for more information #}