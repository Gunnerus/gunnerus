{% extends 'reserver/base.html' %}
{% load bootstrap3 %}
{% block content %}

{# Display a form #}
<section class="container">
	<div class="msg-container">{{announcements}}{% bootstrap_messages %}</div>
	<div class="panel panel-default">
		<div class="panel-heading">
			<h3 class="panel-title">Select a period</h3>
		</div>
		<div class="panel-body">
			<div class="form-group">
				<label class="control-label" for="id_search_start_date">Start date</label>
				<input type="text" name="search_start_date" value="" id="id_search_start_date" placeholder="Period start date" title="" class="form-control">
			</div>
			<div class="form-group">
				<label class="control-label" for="id_search_end_date">End date</label>
				<input type="text" name="search_end_date" value="" id="id_search_end_date" placeholder="Period end date" title="" class="form-control">
			</div>
		</div>
		<div class="panel-footer">
			<div class="btn-group btn-group-justified">
				<a id="search_btn" href="#" class="btn btn-primary">
					<span class="glyphicon glyphicon-search"></span> Search
				</a>
			</div>
		</div>
	</div>
	{% if has_dates_selected %}
	<div class="invoices-container">
	<h3 class="sub-sub-header" id="results-header">Results for {{start_date}} to {{end_date}}</h3>
	<div class="panel panel-default">
		<div class="panel-heading">
			<h3 class="panel-title">Period summary</h3>
		</div>
		<div class="panel-body">
			<h4>Number of invoices</h4>
			<p>{{ invoices|length }}</p>
			<h4>Number of cruises</h4>
			<p>{{ cruises|length }}</p>
			<h4>Cruise leaders</h4>
			<p>
				<ul>
					{% for cruise_leader in cruise_leaders %}
					<li>{{ cruise_leader.get_full_name }}</li>
					{% empty %}
					<li>None</li>
					{% endfor %}
				</ul>
			</p>
			<h4>Sum of invoices</h4>
			<p>{{ invoice_sum }} NOK</p>
		</div>
	</div>
	<h3 class="sub-sub-header">Invoices</h3>
	{% if invoices|length > 0 %}
		<div class="jump-target" id="unapproved-cruises-needing-attention"></div>
		{% for invoice in invoices %}
		<div class="panel {% if not invoice.is_sent %}panel-warning{% else %}panel-default{% endif %}">
			<div class="panel-heading">
				<h3 class="panel-title">{{ invoice }}</h3>
			</div>
			<div class="panel-body">
				<h4>Sent</h4>
				{% if invoice.is_sent %}
				<p>Yes</p>
				{% else %}
				<p>No</p>
				{% endif %}
				
				{% if invoice.business_reg_num %}
				<h4>Business number</h4>
				<p>{{ invoice.business_reg_num }}</p>
				{% endif %}
				
				{% if invoice.billing_address %}
				<h4>Billing address</h4>
				<p>{{ invoice.billing_address }}</p>
				{% endif %}
				
				{% if invoice.accounting_place %}
				<h4>Accounting place</h4>
				<p>{{ invoice.accounting_place }}</p>
				{% endif %}
				
				{% if invoice.project_number %}
				<h4>Project number</h4>
				<p>{{ invoice.project_number }}</p>
				{% endif %}

				{% if invoice.project_leader %}
				<h4>Project leader</h4>
				<p>{{ invoice.project_leader }}</p>
				{% endif %}
				
				{% if invoice.course_code %}
				<h4>Course code</h4>
				<p>{{ invoice.course_code }}</p>
				{% endif %}
				
				{% if invoice.course_lecturer %}
				<h4>Course lecturer</h4>
				<p>{{ invoice.course_lecturer }}</p>
				{% endif %}
				
				{% if invoice.reference %}
				<h4>Reference</h4>
				<p>{{ invoice.reference }}</p>
				{% endif %}
				
				{% if invoice.contact_email %}
				<h4>Contact email</h4>
				<p>{{ invoice.contact_email }}</p>
				{% endif %}

				<h4>Invoice items</h4>
				<div class="table-responsive">
					<table class="table table-striped">
						<thead>
							<tr>
								<th>Description</th>
								<th>Price</th>
								{% if request.user.is_superuser %}
								<th>Actions</th>
								{% endif %}
							</tr>
						</thead>
						<tbody>
							{% for item in invoice.get_list_prices %}
								<tr>
									<td>{{ item }}</td>
									<td>{{ item.price }} NOK</td>
									{% if request.user.is_superuser %}
									<td>
										{% if not item.is_generated %}
										<a href="{% url 'edit-invoice-item' item.pk %}" class="btn btn-primary">
											{% bootstrap_icon "pencil" %} Edit
										</a>
										<a href="{% url 'remove-invoice-item' item.pk %}" class="btn btn-danger">
											{% bootstrap_icon "remove" %} Remove
										</a>
										{% else %}
										None for generated items
										{% endif %}
									</td>
									{% endif %}
								</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
				{% if request.user.is_superuser %}
				{% buttons %}
					<a href="{% url 'add-invoice-item' invoice.pk %}" class="btn btn-success">
						{% bootstrap_icon "plus" %} Add item
					</a>
				{% endbuttons %}
				{% endif %}
				
				<h4>Sum</h4>
				<p>{{ invoice.get_sum }} NOK</p>
			</div>
			<div class="panel-footer">
				{% buttons %}
					<a href="{% url 'cruise-view' invoice.pk %}" disabled class="disabled btn btn-info">
						{% bootstrap_icon "download-alt" %} Export to PDF
					</a>
					{% if request.user.is_superuser %}
					{% if invoice.is_sent %}
					<a href="{% url 'invoice-mark-as-unsent' invoice.pk %}" class="btn btn-danger">
						{% bootstrap_icon "remove" %} Mark as unsent
					</a>
					{% else %}
					<a href="{% url 'invoice-mark-as-sent' invoice.pk %}" class="btn btn-primary">
						{% bootstrap_icon "ok" %} Mark as sent
					</a>
					{% endif %}
					{% endif %}
				{% endbuttons %}
			</div>
		</div>
		{% endfor %}
	{% else %}
	<p>There were no results.</p>
	{% endif %}
	</div>
	{% endif %}
</section>
{% endblock %}
{% block scripts %}
<script>
var start_date = "";
var end_date = "";

function update_search_url() {
	var date_regex = /(\d{4}\-(0?[1-9]|1[012])\-(0?[1-9]|[12][0-9]|3[01]))/;
	if (date_regex.test(start_date) && date_regex.test(end_date)) {
		document.querySelector("#search_btn").href = "/invoices/history/from-" + start_date + "-to-" + end_date;
		$("#search_btn").removeClass("disabled");
		$("#search_btn").prop("disabled", false);
	} else {
		$("#search_btn").addClass("disabled");
		$("#search_btn").prop("disabled", true);
	}
}

$(document).ready(function() {
	var url_date_regex = /\/invoices\/history\/from\-(\d{4}\-(0?[1-9]|1[012])\-(0?[1-9]|[12][0-9]|3[01]))\-to\-(\d{4}\-(0?[1-9]|1[012])\-(0?[1-9]|[12][0-9]|3[01]))$/;
	if (url_date_regex.test(window.location.href)) {
		start_date = url_date_regex.exec(window.location.href)[1];
		end_date = url_date_regex.exec(window.location.href)[4];
		document.querySelector("input#id_search_start_date").value = start_date;
		document.querySelector("input#id_search_end_date").value = end_date;
		update_search_url();
	}
});

$('#search_btn').click(function() {
    update_search_url();
});

$("input#id_search_start_date").change(function(){
	start_date = this.value;
	update_search_url();
});

$("input#id_search_end_date").change(function(){
	end_date = this.value;
	update_search_url();
});



</script>
{% endblock %}